import os
import tensorflow as tf
from art.estimators.classification import TensorFlowV2Classifier
from sklearn.model_selection import train_test_split
# from tensorflow.keras.datasets import mnist
import numpy as np
import PIL


def load_malware_images():
    malware_path_arm = 'grayscale_image_sample_data/malware/arm'
    malware_path_mips = 'grayscale_image_sample_data/malware/mips'

    malware_files = []
    for file_name in os.listdir(malware_path_arm):
        file_path = os.path.join(malware_path_arm, file_name)
        # with open(file_path, 'rb') as f:
        img = np.asarray(PIL.Image.open(file_path))
        # malware_files.append(np.frombuffer(f.read(), dtype=np.uint8))
        # print(img.shape)
        # print(img)
        # exit()
        malware_files.append(img)

    for file_name in os.listdir(malware_path_mips):
        file_path = os.path.join(malware_path_mips, file_name)
        # with open(file_path, 'rb') as f:
        img = np.asarray(PIL.Image.open(file_path))
        # malware_files.append(np.frombuffer(f.read(), dtype=np.uint8))
        malware_files.append(img)
    tensor = tf.convert_to_tensor(malware_files)
    return tensor


def load_benign_images():
    benign_path_arm = 'grayscale_image_sample_data/benign/arm'
    benign_path_mips = 'grayscale_image_sample_data/malware/mips'

    benign_files = []
    for file_name in os.listdir(benign_path_arm):
        file_path = os.path.join(benign_path_arm, file_name)
        img = np.asarray(PIL.Image.open(file_path))
        benign_files.append(img)

    for file_name in os.listdir(benign_path_mips):
        file_path = os.path.join(benign_path_mips, file_name)
        img = np.asarray(PIL.Image.open(file_path))
        benign_files.append(img)

    tensor = tf.convert_to_tensor(benign_files)
    return tensor


# Define the model
model = tf.keras.models.Sequential([
    tf.keras.layers.Reshape((90, 90, 1), input_shape=(90, 90)),
    tf.keras.layers.Conv2D(32, kernel_size=(3, 3), activation='relu'),
    tf.keras.layers.MaxPooling2D(pool_size=(2, 2)),
    tf.keras.layers.Flatten(),
    tf.keras.layers.Dense(128, activation='relu'),
    tf.keras.layers.Dense(1, activation='sigmoid')
])

# Compile the model
model.compile(loss='binary_crossentropy',
              optimizer='adam',
              metrics=['accuracy'])

# Load malware and benign images
malware_images = load_malware_images()  # replace with your own function
benign_images = load_benign_images()  # replace with your own function

# Combine images and labels
x = np.concatenate((malware_images, benign_images), axis=0)
y = np.concatenate((np.ones(len(malware_images)), np.zeros(len(benign_images))))

# Shuffle data
shuffle_idx = np.random.permutation(len(x))
x = x[shuffle_idx]
y = y[shuffle_idx]

# Split data into training and testing sets
x_train, x_test, y_train, y_test = train_test_split(x, y, test_size=0.2)

classifier = TensorFlowV2Classifier(
    model=model,
    clip_values=(0, 1),
    input_shape=(90, 90, 1),
    nb_classes=2,  # Assuming binary classification (malware/benign)
)

classifier.fit(x_train, y_train, batch_size=64, nb_epochs=10)

predictions = classifier.predict(x_test)
accuracy = np.sum(np.argmax(predictions, axis=1) == np.argmax(y_test, axis=1)) / len(y_test)
print("Accuracy on benign test examples: {}%".format(accuracy * 100))

# Generate adversarial test examples
